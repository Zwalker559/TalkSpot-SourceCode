rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======== Helper Functions ========
    
    function isOwnerOf(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function getRole(userId) {
      return getUserData(userId).role;
    }
    
    function getMyRole() {
      return getRole(request.auth.uid);
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // --- Hierarchical Role Checks ---
    
    function isOwner() {
      return getMyRole() == 'Owner';
    }
    
    function isCoOwnerOrHigher() {
      return getMyRole() in ['Owner', 'Co-Owner'];
    }
    
    function isLeadManagerOrHigher() {
       return getMyRole() in ['Owner', 'Co-Owner', 'Lead-Manager'];
    }
    
    function isSubManagerOrHigher() {
       return getMyRole() in ['Owner', 'Co-Owner', 'Lead-Manager', 'Sub-Manager'];
    }
    
    // Check if the current user has a higher role than a target user.
    function hasHigherRoleThan(targetUserId) {
      let myRole = getMyRole();
      let targetRole = getRole(targetUserId);
      
      // Define role hierarchy
      let roles = {
        'User': 0,
        'Sub-Manager': 1,
        'Lead-Manager': 2,
        'Co-Owner': 3,
        'Owner': 4
      };
      
      return roles[myRole] > roles[targetRole];
    }
    

    // ======== Collection Rules ========

    match /users/{userId} {
      // Any authenticated user can read profiles (needed for other rules and app functionality)
      allow read: if isAuthenticated();
      // Only the user themselves can create their own document
      allow create: if isOwnerOf(userId);
      
      // A user can update their own profile, or an admin can update a user with a lower role.
      allow update: if isOwnerOf(userId) || hasHigherRoleThan(userId);
      
      // An admin can delete a user with a lower role (you can't delete yourself this way).
      allow delete: if hasHigherRoleThan(userId);
    }

    match /user_lookups/{lookupId} {
      allow read: if true; // Publicly readable for user searching
      allow create: if isOwnerOf(request.resource.data.uid);
      allow update: if isOwnerOf(resource.data.uid) || isSubManagerOrHigher();
      allow delete: if isSubManagerOrHigher(); // Only managers and above can delete lookup data
    }

    match /password_recovery/{userId} {
      allow read: if true; // Needed for password reset flow
      allow create, update: if isOwnerOf(userId);
      allow delete: if isCoOwnerOrHigher(); // Only high-level admins can remove recovery info during clean-up
    }

    match /requests/{requestId} {
      // Only the sender or receiver of a request can interact with it
      allow read, update, delete: if isOwnerOf(resource.data.to) || isOwnerOf(resource.data.from);
      allow create: if isOwnerOf(request.resource.data.from);
    }

    match /conversations/{conversationId} {
      // Participants can manage their own conversations. High-level admins can manage any conversation.
      allow read, update: if request.auth.uid in resource.data.participants || isCoOwnerOrHigher();
      allow create: if request.auth.uid in request.resource.data.participants;
      allow delete: if isCoOwnerOrHigher() || (request.auth.uid in resource.data.participants);
    }

    match /conversations/{conversationId}/messages/{messageId} {
       // Participants can access messages in their conversations. High-level admins can access any message.
       allow read: if request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants || isCoOwnerOrHigher();
       allow create: if isOwnerOf(request.resource.data.senderId) && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
       // The message sender or a high-level admin can delete a message.
       allow delete: if isOwnerOf(resource.data.senderId) || isCoOwnerOrHigher();
    }
    
    match /Sponsorships/{sponsorshipId} {
      allow read: if true; // Ads are public
      // All managers and above can create/edit ads
      allow write: if isSubManagerOrHigher();
    }

    match /audit_logs/{logId} {
      // Only Owners can read or write to audit logs.
      allow read, write: if isOwner();
    }
    
    match /site_config/{docId} {
    	// Allow any authenticated user to read site config like notices
    	allow read: if isAuthenticated();
      // Only Owners and Co-Owners can write to site config
      allow write: if isCoOwnerOrHigher();
    }
  }
}

    