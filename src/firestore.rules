
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======== Helper Functions ========
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function getRole(userId) {
      return getUserData(userId).role;
    }
    
    function getMyRole() {
      return getRole(request.auth.uid);
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // --- Hierarchical Role Checks ---
    
    function isOwnerRole() {
      return getMyRole() == 'Owner';
    }
    
    function isCoOwnerOrHigher() {
      return getMyRole() in ['Owner', 'Co-Owner'];
    }
    
    function isLeadManagerOrHigher() {
       return getMyRole() in ['Owner', 'Co-Owner', 'Lead-Manager'];
    }
    
    function isSubManagerOrHigher() {
       return getMyRole() in ['Owner', 'Co-Owner', 'Lead-Manager', 'Sub-Manager'];
    }
    
    function hasHigherRoleThan(targetUserId) {
      let myRole = getMyRole();
      let targetRole = getRole(targetUserId);
      
      let roles = {
        'User': 0,
        'Sub-Manager': 1,
        'Lead-Manager': 2,
        'Co-Owner': 3,
        'Owner': 4
      };
      
      return roles[myRole] > roles[targetRole];
    }
    

    // ======== Collection Rules ========

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || hasHigherRoleThan(userId);
      allow delete: if hasHigherRoleThan(userId);
    }

    match /user_lookups/{lookupId} {
      allow read: if true;
      allow create: if isOwner(request.resource.data.uid);
      allow update: if isOwner(resource.data.uid) || isSubManagerOrHigher();
      allow delete: if isSubManagerOrHigher();
    }

    match /password_recovery/{userId} {
      allow read: if true;
      allow create, update: if isOwner(userId);
      allow delete: if isCoOwnerOrHigher();
    }

    match /requests/{requestId} {
      allow read, update, delete: if isOwner(resource.data.to) || isOwner(resource.data.from);
      allow create: if isOwner(request.resource.data.from);
    }

    match /conversations/{conversationId} {
      allow read, update: if request.auth.uid in resource.data.participants || isCoOwnerOrHigher();
      allow create: if request.auth.uid in request.resource.data.participants;
      allow delete: if (request.auth.uid in resource.data.participants) || isCoOwnerOrHigher();
    }

    match /conversations/{conversationId}/messages/{messageId} {
       allow read: if request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants || isCoOwnerOrHigher();
       allow create: if isOwner(request.resource.data.senderId) && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
       allow delete: if isOwner(resource.data.senderId) || isCoOwnerOrHigher();
    }
    
    match /sponsorships/{sponsorshipId} {
      allow read: if true;
      allow write: if isSubManagerOrHigher();
    }

    match /audits/{auditId} {
      allow read, write: if isOwnerRole();
    }
    
    match /announcements/{docId} {
    	allow read: if isAuthenticated();
      allow write: if isCoOwnerOrHigher();
    }
  }
}
    
